<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>d3 charts</title>
    <meta name="description" content="d3 charts">
    <meta name="author" content="Decio Battaglia">
    <link href='http://fonts.googleapis.com/css?family=PT+Mono' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="main.css?v=1.0">
  </head>
  <body>
    <div id="viz"></div>
    <script src="../lib/lodash/dist/lodash.js"></script>
    <script src="lib/d3/d3.js"></script>
    <script src="build/chart.js"></script>
    <script>
      //var data = [{name: 'tot', value: 23}, {name: 'rot', value: 75}];
      function accessor(d) {
        // csv headers:
        // year,rank,country,agglomeration,population
        return {
          year: +d.year, //new Date(+d.year, 0, 1), // convert "Year" column to Date
          rank: d.rank,
          country: d.country,
          agglomeration: d.agglomeration,
          population: +d.population
        };
      }
      d3.csv("data/WUP2011-F11a-30_Largest_Cities.csv",
       accessor  , function(error, data) {
          var current_year, data_by_year, selection, bar;
          current_year = 1950;
          data_by_year = _.groupBy( data, function (obj) {
            return obj.year;
          });
          selection = d3.select("#viz")
          function handleTransitionEnd () {
            current_year += 5;
            if (data_by_year[current_year]) {
              setTimeout(function(){
                selection.datum(data_by_year[current_year]).call(bar);
              },400);
            }
          }
          bar = chart.bar()
              .margin({top: 10, right: 20, bottom: 20, left: 340})
              .width(1200)
              .height(900)
              //.duration(1200)
              .step(400)
              .xValue( function(d) { return d['agglomeration']; } )
              .yValue( function(d) { return d['population']; } )
              .handleTransitionEnd( handleTransitionEnd )
              .orient( 'horizontal' );
              //.orient( 'vertical' );
          selection.datum(data_by_year[current_year]).call(bar);
      });
    </script>
  </body>
</html>